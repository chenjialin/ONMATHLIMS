{% extends 'base.html' %}

{%block header_script %}
<meta charset="UTF-8">
<title></title>
{% load staticfiles %}
<link rel="stylesheet" href="{% static "css/ui.jqgrid.css" %}" />
<link rel="stylesheet" href="{% static "css/jquery-ui-1.8.16.custom.css" %}" />
<script type="text/javascript" src="{% static "js/jquery-2.0.0.min.js" %}"></script>
<script type="text/javascript" src="{% static "js/jquery.jqGrid.src.js"%}"></script>
<script type="text/javascript" src="{% static "js/grid.locale-cn.js" %}"></script>
<script type="text/javascript" src="{% static "js/sample.js" %}"></script>
<script type="text/javascript" src="{% static "js/xlsx.core.min.js" %}"></script>
<!--<script src="{% static "js/main.js" %}"></script> -->
{% endblock %}

{% block content_header %}
<h1>上传{{table_name}}结果</h1>
<ol class="breadcrumb">
    <li><a href="{% url 'main' %}"><i class="fa fa-dashboard"></i>Home</a></li>
    <li class="active">上传数据</li>
</ol>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-xs-12">
        <div class="box">
            <div class="box-header">
                <div class="btn-group">
                  <button type="submit" class="btn btn-default fa add">增加行</button>
                  <button type="submit" class="btn btn-default fa edit">编辑行</button>
                  <button type="submit" class="btn btn-default fa del">删除行</button>
                  <button type="submit" class="btn btn-default fa save">保存表格</button>
                </div>
                <span class="help-block"><b>样品详细信息：（请填写下表，如果您的样品数量较多建议您填写电子版表格后直接上传）</b>
                  {% if table == 'quality_check' %}
                      <a href="static/download/quality_check.xlsx" style="font-size: smaller ">点击下载模板</a>
                  {% elif table == 'build_lib' %}
                      <a href="static/download/build_lib.xlsx" style="font-size: smaller ">点击下载模板</a>
                  {% elif table == 'upmachine' %}
                      <a href="static/download/upmachine.xlsx" style="font-size: smaller ">点击下载模板</a>
                  {% elif table == 'downmachine' %}
                      <a href="static/download/downmachine.xlsx" style="font-size: smaller ">点击下载模板</a>
                  {% endif %}
                  <input type="file" accept=" application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" id="upload_excel" />
                </span>
                <div class="box-tools">
                    <div class="input-group input-group-sm" style="width: 150px;">
                        <input type="text" name="table_search" class="form-control pull-right" placeholder="Search">

                        <div class="input-group-btn">
                            <button type="submit" class="btn btn-default"><i class="fa fa-search"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.box-header -->
            <div class="box-body table-responsive no-padding">
              <table id="table" class="table table-hover"></table>
              <button id="submit">提交样品表</button>
            </div>
            <!-- /.box-body -->
        </div>
        <!-- /.box -->
    </div>
</div>
{% endblock %}
  <!-- <input type="button" class="del" value="删除行"/> -->
  {% block page_script %}
  <script>
  /*
      $(document).ready(function(){
          $(".tree >li").removeClass('active');
          $("#receive_sample").addClass("active");
      });
  */
  //var project_id = {{ project_id }};
  var table_map = {
    '样品名称':'sample_name',
    '物种':'sepcies',
    '管数':'product_num',
    '建库类型':'library_type',
    '浓度(ng/uL)':'concentration',
    '体积(ul)':'volume',
    '总量(ug)':'data_quantity',
    '片段长度(bp)':'fragment_length',
    'OD260/280':'od_260_or_280',
    'OD260/230':'od_260_or_230',
    '备注':'comment'
  };

  	$("#table").jqGrid(
  		{
  			url: 'save',
  			datatype : 'local',
  			height: 500,
  			// height: 'auto',
  			colNames: ['样品编号', '样品名称', 'rin值','浓度(ng/uL)','体积(ul)', '判定结果', '时间', '备注'],
  			colModel: [
  						{ name: 'sample_id', index: 'sample_id', editable: true, width: 60},
  						{ name: 'sample_name', index: 'sample_name', editable: true, width: 60},
  						{ name: 'rin', index: 'rin', editable: true, width: 60},
  						{ name: 'concentration', index: 'concentration', editable: true, width: 60},
  						{ name: 'volume', index: 'volume', editable: true, width: 60},
  						{ name: 'qualitycheck_results', index: 'qualitycheck_results', editable: true, width: 60},
  						{ name: 'qualitycheck_time', index: 'qualitycheck_time', editable: true, width: 60},
  						{ name: 'qualitycheck_comment', index: 'qualitycheck_comment', editable: true, width: 60}
  					],
  			gridComplete: function() {},
  			caption : "质检结果",//表格的标题名字
  			width: 1000
  		});

  $('#upload_excel').bind('change', handleFile);

  $(".add").unbind().bind('click', function(){
    var jq_obj = $("#table");
    var ids= jq_obj.getDataIDs();
    var new_row_id = ids.length == 0 ? '1' : parseInt(ids[ids.length-1].replace(/[^0-9]/ig,""))+1;
    var id = jq_obj.jqGrid('getGridParam','selrow');
    if (id) {jq_obj.saveRow( id, '', '/save_sample_row');}
    jq_obj.addRowData(new_row_id, {});
    jq_obj.editRow(new_row_id);
    jq_obj.setSelection(new_row_id);
    current_input_row = new_row_id;
  });

  $(".edit").unbind().bind('click', function(){
    var id = $('#table').jqGrid('getGridParam','selrow');
    $("#table").jqGrid('editRow',id);
  });

  $(".del").unbind().bind('click', function(){
    var id = $('#table').jqGrid('getGridParam','selrow');
    if(id){
      $("#table").delRowData(id);
    }else{
      if(current_input_row) {
      $("#table").delRowData(current_input_row);
      }
      var ids= $("#table").getDataIDs();
      current_input_row = ids.length == 0 ? '1' : parseInt(ids[ids.length-1].replace(/[^0-9]/ig,""));
    }
  });

  $("#table").on('click', "input", function (){
    current_input_row = this.parentNode.parentNode.id;
  });

  $(".save").unbind().bind('click', function() {
    save_sample_table();
  });

  $("#submit").unbind().bind('click', function () {
    save_sample_table();
    var status = confirm("确认提交样品表信息?");
    if (status) {
      var sample_table_data = $("#table").getRowData();
      var params = {'sample_table_data': JSON.stringify(sample_table_data), 'project_id': project_id};
      ajaxSend('/save_sample_table', params, function (data) {
        if (data.errcode !=0) {
                    alert('保存失败!');
                }
                else {
                    alert(data.msg);
                    window.location.href='/';
                }
      }, 'POST');
    }


  });

  function handleFile(e) {
        var files = e.target.files;
        var i,f;
        for (i = 0, f = files[i]; i != files.length; ++i) {
            var reader = new FileReader();
            var name = f.name;
            reader.onload = function(e) {
                var data = e.target.result;

                var workbook = XLSX.read(data, {type: 'binary'});
                var sheet_name_list = workbook.SheetNames;
                var result = [];
                var headItem=[];
                var dataItem=[];
                var dataFormulae=[];
                var dataCsv=[];

                sheet_name_list.forEach(function(y) {
                    var worksheet = workbook.Sheets[y];
                    var json = XLSX.utils.sheet_to_json(workbook.Sheets[y]);
                    var formulae = XLSX.utils.sheet_to_formulae(workbook.Sheets[y]);
                    var csv = XLSX.utils.sheet_to_formulae(workbook.Sheets[y]);
                    if(json.length > 0){
                        result=json;
                    }
                });
        var transform_json=[];
                $.each(result,function (i,val) {
          var temp_obj={};
          for(value in table_map){
            if(val[value]){
              temp_obj[table_map[value]] = val[value];
            }
          }
          transform_json.push(temp_obj);
                })
        for(var i=0;i<=transform_json.length;i++){
          $("#table").addRowData(i+1,transform_json[i]);
        };
            };
            reader.readAsBinaryString(f);
        }
        $('#upload_excel').val('');
    }

  function save_sample_table() {
    var ids = $("#table").getDataIDs();
    for (var i in ids) {
      $("#table").saveRow(ids[i], '', 'save_row');
    }
  }

  function show_old_sample() {
    ajaxSend('get_sample_table_data', {'project_id': project_id}, function(data) {
      if (data.errcode !=0) {
        alert(data.msg);
      }
      else {
        var ret_data = data.data;
        var table_obj = $("#table");
        for (var i in ret_data) {
          i = parseInt(i);
          table_obj.addRowData(i+1, ret_data[i]);
        }
      }
    });
  }
  </script>
  {% endblock %}
